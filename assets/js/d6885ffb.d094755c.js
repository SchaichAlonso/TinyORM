"use strict";(self.webpackChunktinyorm_github_io=self.webpackChunktinyorm_github_io||[]).push([[63],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=u(n),h=r,c=m["".concat(s,".").concat(h)]||m[h]||p[h]||o;return n?a.createElement(c,i(i({ref:t},d),{},{components:n})):a.createElement(c,i({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6805:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return p}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={sidebar_position:6,description:"TinyORM's database query builder provides a convenient, fluent interface to creating and running database queries. It can be used to perform most database operations in your application. The query builder uses QSqlQuery parameter binding to protect your application against SQL injection attacks. There is no need to clean or sanitize strings passed to the query builder as query bindings."},s="Database: Query Builder",u={unversionedId:"query-builder",id:"query-builder",title:"Database: Query Builder",description:"TinyORM's database query builder provides a convenient, fluent interface to creating and running database queries. It can be used to perform most database operations in your application. The query builder uses QSqlQuery parameter binding to protect your application against SQL injection attacks. There is no need to clean or sanitize strings passed to the query builder as query bindings.",source:"@site/docs/query-builder.mdx",sourceDirName:".",slug:"/query-builder",permalink:"/query-builder",editUrl:"https://github.com/silverqx/TinyORM-github.io/edit/main/docs/query-builder.mdx",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,description:"TinyORM's database query builder provides a convenient, fluent interface to creating and running database queries. It can be used to perform most database operations in your application. The query builder uses QSqlQuery parameter binding to protect your application against SQL injection attacks. There is no need to clean or sanitize strings passed to the query builder as query bindings."},sidebar:"tutorialSidebar",previous:{title:"Database: Getting Started",permalink:"/database"},next:{title:"Database: Schema Builder",permalink:"/schema-builder"}},d={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Running Database Queries",id:"running-database-queries",level:2},{value:"Retrieving All Rows From A Table",id:"retrieving-all-rows-from-a-table",level:4},{value:"Retrieving A Single Row / Column From A Table",id:"retrieving-a-single-row--column-from-a-table",level:4},{value:"Retrieving A List Of Column Values",id:"retrieving-a-list-of-column-values",level:4},{value:"Aggregates",id:"aggregates",level:3},{value:"Select Statements",id:"select-statements",level:2},{value:"Specifying A Select Clause",id:"specifying-a-select-clause",level:4},{value:"Raw Expressions",id:"raw-expressions",level:2},{value:"Raw Methods",id:"raw-methods",level:3},{value:"<code>selectRaw</code>",id:"selectraw",level:4},{value:"<code>fromRaw</code>",id:"fromraw",level:4},{value:"<code>whereRaw / orWhereRaw</code>",id:"whereraw--orwhereraw",level:4},{value:"<code>groupByRaw</code>",id:"groupbyraw",level:3},{value:"<code>havingRaw / orHavingRaw</code>",id:"havingraw--orhavingraw",level:4},{value:"<code>orderByRaw</code>",id:"orderbyraw",level:4},{value:"Joins",id:"joins",level:2},{value:"Inner Join Clause",id:"inner-join-clause",level:4},{value:"Left Join / Right Join Clause",id:"left-join--right-join-clause",level:4},{value:"Advanced Join Clauses",id:"advanced-join-clauses",level:4},{value:"Subquery Joins",id:"subquery-joins",level:4},{value:"Basic Where Clauses",id:"basic-where-clauses",level:2},{value:"Where Clauses",id:"where-clauses",level:3},{value:"Or Where Clauses",id:"or-where-clauses",level:3},{value:"Condition Operator Overriding",id:"condition-operator-overriding",level:3},{value:"Additional Where Clauses",id:"additional-where-clauses",level:3},{value:"Logical Grouping",id:"logical-grouping",level:3},{value:"Advanced Where Clauses",id:"advanced-where-clauses",level:2},{value:"Subquery Where Clauses",id:"subquery-where-clauses",level:3},{value:"Ordering, Grouping, Limit &amp; Offset",id:"ordering-grouping-limit-and-offset",level:2},{value:"Ordering",id:"ordering",level:3},{value:"The <code>orderBy</code> Method",id:"the-orderby-method",level:4},{value:"The <code>latest</code> &amp; <code>oldest</code> Methods",id:"the-latest--oldest-methods",level:4},{value:"Removing Existing Orderings",id:"removing-existing-orderings",level:4},{value:"Grouping",id:"grouping",level:3},{value:"The <code>groupBy</code> &amp; <code>having</code> Methods",id:"the-groupby--having-methods",level:4},{value:"Limit &amp; Offset",id:"limit-and-offset",level:3},{value:"The <code>skip</code> &amp; <code>take</code> Methods",id:"the-skip--take-methods",level:4},{value:"Insert Statements",id:"insert-statements",level:2},{value:"Auto-Incrementing IDs",id:"auto-incrementing-ids",level:4},{value:"Update Statements",id:"update-statements",level:2},{value:"Increment &amp; Decrement",id:"increment-and-decrement",level:3},{value:"Delete Statements",id:"delete-statements",level:2},{value:"Truncate Statement",id:"truncate-statement",level:3},{value:"Table Truncation &amp; PostgreSQL",id:"table-truncation--postgresql",level:4},{value:"Pessimistic Locking",id:"pessimistic-locking",level:2}],m={toc:p};function h(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"database-query-builder"},"Database: Query Builder"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#introduction"},"Introduction")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#running-database-queries"},"Running Database Queries"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#aggregates"},"Aggregates")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#select-statements"},"Select Statements")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#raw-expressions"},"Raw Expressions")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#joins"},"Joins")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#basic-where-clauses"},"Basic Where Clauses"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#where-clauses"},"Where Clauses")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#or-where-clauses"},"Or Where Clauses")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#additional-where-clauses"},"Additional Where Clauses")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#condition-operator-overriding"},"Condition Operator Overriding")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#logical-grouping"},"Logical Grouping")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#advanced-where-clauses"},"Advanced Where Clauses"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#subquery-where-clauses"},"Subquery Where Clauses")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#ordering-grouping-limit-and-offset"},"Ordering, Grouping, Limit & Offset"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#ordering"},"Ordering")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#grouping"},"Grouping")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#limit-and-offset"},"Limit & Offset")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#insert-statements"},"Insert Statements")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#update-statements"},"Update Statements"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#increment-and-decrement"},"Increment & Decrement")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#delete-statements"},"Delete Statements"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#truncate-statement"},"Truncate Statement")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#pessimistic-locking"},"Pessimistic Locking"))),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"TinyORM's database query builder provides a convenient, fluent interface to creating and running database queries. It can be used to perform most database operations in your application."),(0,o.kt)("p",null,"The TinyORM query builder uses ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery")," parameter binding to protect your application against SQL injection attacks. There is no need to clean or sanitize strings passed to the query builder as query bindings."),(0,o.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery"),' does not support binding column names. Therefore, you should never allow user input to dictate the column names referenced by your queries, including "order by" columns.'))),(0,o.kt)("h2",{id:"running-database-queries"},"Running Database Queries"),(0,o.kt)("h4",{id:"retrieving-all-rows-from-a-table"},"Retrieving All Rows From A Table"),(0,o.kt)("p",null,"You may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"table")," method provided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"DB")," facade to begin a query. The ",(0,o.kt)("inlineCode",{parentName:"p"},"table")," method returns a fluent query builder instance for the given table, allowing you to chain more constraints onto the query and then finally retrieve the results of the query using the ",(0,o.kt)("inlineCode",{parentName:"p"},"get")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n\n// Log a list of all of the application\'s users\nauto query = DB::table("users")->get();\n\nwhile (query.next())\n    qDebug() << "id :" << query.value("id").toULongLong() << ";"\n             << "name :" << query.value("name").toString();\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"get")," method returns a ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery")," containing the results of the query where each result can be accessed by ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery::next")," method, look into the ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery"),' documentation how to obtain results from the "query". You may access each column\'s value by ',(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery::value")," method. The first ",(0,o.kt)("inlineCode",{parentName:"p"},"bool")," return value is the value returned from ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery::exec")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <QDebug>\n\n#include <orm/db.hpp>\n\nauto users = DB::table("users")->get();\n\nwhile(users.next())\n    qDebug() << users.value("name").toString();\n')),(0,o.kt)("h4",{id:"retrieving-a-single-row--column-from-a-table"},"Retrieving A Single Row / Column From A Table"),(0,o.kt)("p",null,"If you just need to retrieve a single row from a database table, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryBuilder::first")," method. This method will return a ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery")," object, on which was internally called ",(0,o.kt)("inlineCode",{parentName:"p"},"QSqlQuery::first")," method. This method retrieves the first record in the result, if available, and positions the query on the retrieved record:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto user = DB::table("users")->whereEq("name", "John").first();\n\nuser.value("email").toString();\n')),(0,o.kt)("p",null,"If you don't need an entire row, you may extract a single value from a record using the ",(0,o.kt)("inlineCode",{parentName:"p"},"value")," method. This method will return the value of the column directly as ",(0,o.kt)("inlineCode",{parentName:"p"},"QVariant"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto email = DB::table("users")->whereEq("name", "John").value("email").toString();\n')),(0,o.kt)("p",null,"To retrieve a single row by its ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," column value, use the ",(0,o.kt)("inlineCode",{parentName:"p"},"find")," method. This method retrieves the first record in the result, if available, and positions the query on the retrieved record:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto user = DB::table("users")->find(3);\n\nuser.value("email").toString();\n')),(0,o.kt)("h4",{id:"retrieving-a-list-of-column-values"},"Retrieving A List Of Column Values"),(0,o.kt)("p",null,"If you would like to retrieve the ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<QVariant>")," instance containing the values of a single column, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"pluck")," method. In this example, we'll retrieve a collection of user titles:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <QDebug>\n\n#include <orm/db.hpp>\n\nconst auto titles = DB::table("users")->pluck("title");\n\nfor (const auto &title : titles)\n    qDebug() << title.value<QString>();\n')),(0,o.kt)("p",null," You may specify the column that the resulting collection should use as its keys by providing a second argument to the ",(0,o.kt)("inlineCode",{parentName:"p"},"pluck")," method, following example returns the ",(0,o.kt)("inlineCode",{parentName:"p"},"std::map<QString, QVariant>"),' of "titles" keyed by "names":'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n\nauto titles = DB::table("users")->pluck<QString>("title", "name");\n\nfor (auto &&[name, title] : titles)\n    qDebug() << name << ":" << title.value<QString>();\n')),(0,o.kt)("p",null,"You may also use ",(0,o.kt)("inlineCode",{parentName:"p"},'pluck<quint64>("name", "id")'),", it returns the ",(0,o.kt)("inlineCode",{parentName:"p"},"std::map<quint64, QVariant>"),' of "names" keyed by its "ids".'),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This second ",(0,o.kt)("inlineCode",{parentName:"p"},"pluck")," overload returns ",(0,o.kt)("inlineCode",{parentName:"p"},"std::map<T, QVariant>")," so you have to provide a template argument for the key type."))),(0,o.kt)("h3",{id:"aggregates"},"Aggregates"),(0,o.kt)("p",null,"The query builder also provides a variety of methods for retrieving aggregate values like ",(0,o.kt)("inlineCode",{parentName:"p"},"count"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"max"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"min"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"avg"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"sum"),". You may call any of these methods after constructing your query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n\nauto users = DB::table("users")->count();\n\nauto price = DB::table("orders")->max("price");\n')),(0,o.kt)("p",null,"Of course, you may combine these methods with other clauses to fine-tune how your aggregate value is calculated:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto price = DB::table("orders")\n                 ->whereEq("finalized", 1)\n                 .avg("price");\n')),(0,o.kt)("h2",{id:"select-statements"},"Select Statements"),(0,o.kt)("h4",{id:"specifying-a-select-clause"},"Specifying A Select Clause"),(0,o.kt)("p",null,"You may not always want to select all columns from a database table. Using the ",(0,o.kt)("inlineCode",{parentName:"p"},"select"),' method, you can specify a custom "select" clause for the query:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n\nauto users = DB::table("users")\n                 ->select({"name", "email as user_email"})\n                 .get();\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"distinct")," method allows you to force the query to return distinct results:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")->distinct().get();\n')),(0,o.kt)("p",null,"If you already have a query builder instance and you wish to add a column to its existing select clause, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"addSelect")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto query = DB::table("users")->select("name");\n\nauto users = query.addSelect("age").get();\n')),(0,o.kt)("h2",{id:"raw-expressions"},"Raw Expressions"),(0,o.kt)("p",null,"Sometimes you may need to insert an arbitrary string into a query. To create a raw string expression, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"raw")," method provided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"DB")," facade:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->select(DB::raw("count(*) as user_count, status"))\n                 .where("status", "<>", 1)\n                 .groupBy("status")\n                 .get();\n')),(0,o.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Raw statements will be injected into the query as strings, so you should be extremely careful to avoid creating SQL injection vulnerabilities."))),(0,o.kt)("h3",{id:"raw-methods"},"Raw Methods"),(0,o.kt)("p",null,"Instead of using the ",(0,o.kt)("inlineCode",{parentName:"p"},"DB::raw")," method, you may also use the following methods to insert a raw expression into various parts of your query. ",(0,o.kt)("strong",{parentName:"p"},"Remember, TinyORM can not guarantee that any query using raw expressions is protected against SQL injection vulnerabilities.")),(0,o.kt)("h4",{id:"selectraw"},(0,o.kt)("inlineCode",{parentName:"h4"},"selectRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"selectRaw")," method can be used in place of ",(0,o.kt)("inlineCode",{parentName:"p"},"addSelect(DB::raw(...))"),". This method accepts an optional vector of bindings as its second argument:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto orders = DB::table("orders")\n                  ->selectRaw("price * ? as price_with_tax", {1.0825})\n                  .get();\n')),(0,o.kt)("h4",{id:"fromraw"},(0,o.kt)("inlineCode",{parentName:"h4"},"fromRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"fromRaw"),' method may be used to provide a raw string as the value of the "from" clause:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::connection("postgres").query()\n                 ->fromRaw("(select id, name from users where id < ?) as u", {5})\n                 .where("id", "<", 3)\n                 .get();\n')),(0,o.kt)("h4",{id:"whereraw--orwhereraw"},(0,o.kt)("inlineCode",{parentName:"h4"},"whereRaw / orWhereRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereRaw")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"orWhereRaw"),' methods can be used to inject a raw "where" clause into your query. These methods accept an optional vector of bindings as their second argument:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto orders = DB::table("orders")\n                  ->whereRaw("price > IF(state = \\"TX\\", ?, 100)", {200})\n                  .get();\n')),(0,o.kt)("h3",{id:"groupbyraw"},(0,o.kt)("inlineCode",{parentName:"h3"},"groupByRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"groupByRaw")," method may be used to provide a raw string as the value of the ",(0,o.kt)("inlineCode",{parentName:"p"},"group by")," clause:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto orders = DB::table("orders")\n                  ->select({"city", "state"})\n                  .groupByRaw("city, state")\n                  .get();\n')),(0,o.kt)("h4",{id:"havingraw--orhavingraw"},(0,o.kt)("inlineCode",{parentName:"h4"},"havingRaw / orHavingRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"havingRaw")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"orHavingRaw"),' methods may be used to provide a raw string as the value of the "having" clause. These methods accept an optional vector of bindings as their second argument:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto orders = DB::table("orders")\n                  ->select({"department", DB::raw("SUM(price) as total_sales")})\n                  .groupBy("department")\n                  .havingRaw("SUM(price) > ?", {2500})\n                  .get();\n')),(0,o.kt)("h4",{id:"orderbyraw"},(0,o.kt)("inlineCode",{parentName:"h4"},"orderByRaw")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"orderByRaw"),' method may be used to provide a raw string as the value of the "order by" clause:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto orders = DB::table("orders")\n                  ->orderByRaw("updated_at - created_at DESC")\n                  .get();\n')),(0,o.kt)("h2",{id:"joins"},"Joins"),(0,o.kt)("h4",{id:"inner-join-clause"},"Inner Join Clause"),(0,o.kt)("p",null,'The query builder may also be used to add join clauses to your queries. To perform a basic "inner join", you may use the ',(0,o.kt)("inlineCode",{parentName:"p"},"join")," method on a query builder instance. The first argument passed to the ",(0,o.kt)("inlineCode",{parentName:"p"},"join")," method is the name of the table you need to join to, while the remaining arguments specify the column constraints for the join. You may even join multiple tables in a single query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n\nauto users = DB::table("users")\n                 ->join("contacts", "users.id", "=", "contacts.user_id")\n                 .join("orders", "users.id", "=", "orders.user_id")\n                 .select({"users.*", "contacts.phone", "orders.price"})\n                 .get();\n')),(0,o.kt)("h4",{id:"left-join--right-join-clause"},"Left Join / Right Join Clause"),(0,o.kt)("p",null,'If you would like to perform a "left join" or "right join" instead of an "inner join", use the ',(0,o.kt)("inlineCode",{parentName:"p"},"leftJoin")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"rightJoin")," methods. These methods have the same signature as the ",(0,o.kt)("inlineCode",{parentName:"p"},"join")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->leftJoin("posts", "users.id", "=", "posts.user_id")\n                 .get();\n\nauto users = DB::table("users")\n                 ->rightJoin("posts", "users.id", "=", "posts.user_id")\n                 .get();\n')),(0,o.kt)("h4",{id:"advanced-join-clauses"},"Advanced Join Clauses"),(0,o.kt)("p",null,"You may also specify more advanced join clauses. To get started, pass a lambda expression as the second argument to the ",(0,o.kt)("inlineCode",{parentName:"p"},"join")," method. The lambda expression will receive a ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::Query::JoinClause"),' instance which allows you to specify constraints on the "join" clause:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include <orm/db.hpp>\n#include <orm/query/joinclause.hpp>\n\nDB::table("users")\n    ->join("contacts", [](auto &join)\n    {\n        join.on("users.id", "=", "contacts.user_id")\n            .orOn(...);\n    })\n    .get();\n')),(0,o.kt)("p",null,'If you would like to use a "where" clause on your joins, you may use the ',(0,o.kt)("inlineCode",{parentName:"p"},"where")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"orWhere")," methods provided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::Query::JoinClause")," instance. Instead of comparing two columns, these methods will compare the column against a value:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")\n    ->join("contacts", [](auto &join)\n    {\n        join.on("users.id", "=", "contacts.user_id")\n            .where("contacts.user_id", ">", 5);\n    })\n    .get();\n')),(0,o.kt)("h4",{id:"subquery-joins"},"Subquery Joins"),(0,o.kt)("p",null,"You may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"joinSub"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"leftJoinSub"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"rightJoinSub")," methods to join a query to a subquery. Each of these methods receives three arguments: the subquery, its table alias, and a lambda expression that defines the related columns. In this example, we will retrieve a collection of users where each user record also contains the ",(0,o.kt)("inlineCode",{parentName:"p"},"created_at")," timestamp of the user's most recently published blog post:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto latestPosts = DB::table("posts")\n                   ->select({"user_id", DB::raw("MAX(created_at) as last_post_created_at")})\n                   .whereEq("is_published", true)\n                   .groupBy("user_id");\n\nauto users = DB::table("users")\n                 ->joinSub(latestPosts, "latest_posts", [](auto &join)\n                 {\n                     join.on("users.id", "=", "latest_posts.user_id");\n                 }).get();\n')),(0,o.kt)("h2",{id:"basic-where-clauses"},"Basic Where Clauses"),(0,o.kt)("h3",{id:"where-clauses"},"Where Clauses"),(0,o.kt)("p",null,"You may use the query builder's ",(0,o.kt)("inlineCode",{parentName:"p"},"where"),' method to add "where" clauses to the query. The most basic call to the ',(0,o.kt)("inlineCode",{parentName:"p"},"where")," method requires three arguments. The first argument is the name of the column. The second argument is an operator, which can be any of the database's supported operators. The third argument is the value to compare against the column's value."),(0,o.kt)("p",null,"For example, the following query retrieves users where the value of the ",(0,o.kt)("inlineCode",{parentName:"p"},"votes")," column is equal to ",(0,o.kt)("inlineCode",{parentName:"p"},"100")," and the value of the ",(0,o.kt)("inlineCode",{parentName:"p"},"age")," column is greater than ",(0,o.kt)("inlineCode",{parentName:"p"},"35"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where("votes", "=", 100)\n                 .where("age", ">", 35)\n                 .get();\n')),(0,o.kt)("p",null,"For convenience, if you want to verify that a column is ",(0,o.kt)("inlineCode",{parentName:"p"},"=")," to a given value, you may call ",(0,o.kt)("inlineCode",{parentName:"p"},"whereEq")," method. Similar ",(0,o.kt)("inlineCode",{parentName:"p"},"XxxEq")," methods are also defined for other commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")->whereEq("votes", 100).get();\n')),(0,o.kt)("p",null,"As previously mentioned, you may use any operator that is supported by your database system:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where("votes", ">=", 100)\n                 .get();\n\nauto users = DB::table("users")\n                 ->where("votes", "<>", 100)\n                 .get();\n\nauto users = DB::table("users")\n                 ->where("name", "like", "T%")\n                 .get();\n')),(0,o.kt)("p",null,"You may also pass a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<Orm::WhereItem>")," of conditions to the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," function. Each ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::WhereItem")," structure should contain the four arguments typically passed to the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where({\n                     {"status", 1}, // "=" by default\n                     {"subscribed", 1, "<>"},\n                 }).get();\n')),(0,o.kt)("h3",{id:"or-where-clauses"},"Or Where Clauses"),(0,o.kt)("p",null,"When chaining together calls to the query builder's ",(0,o.kt)("inlineCode",{parentName:"p"},"where"),' method, the "where" clauses will be joined together using the ',(0,o.kt)("inlineCode",{parentName:"p"},"and")," operator. However, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"orWhere")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"orWhereEq")," method to join a clause to the query using the ",(0,o.kt)("inlineCode",{parentName:"p"},"or")," operator. The ",(0,o.kt)("inlineCode",{parentName:"p"},"orWhere")," method accepts the same arguments as the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where("votes", ">", 100)\n                 .orWhere("name", "=", "John")\n                 .orWhereEq("name", "Jack")\n                 .get();\n')),(0,o.kt)("p",null,'If you need to group an "or" condition within parentheses, you may pass a lambda expression as the first argument to the ',(0,o.kt)("inlineCode",{parentName:"p"},"orWhere")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where("votes", ">", 100)\n                 .orWhere([](auto &query)\n                 {\n                     query.whereEq("name", "Abigail")\n                          .where("votes", ">", 50);\n                 })\n                 .get();\n')),(0,o.kt)("p",null,"The example above will produce the following SQL:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'select * from users where votes > 100 or (name = "Abigail" and votes > 50)\n')),(0,o.kt)("h3",{id:"condition-operator-overriding"},"Condition Operator Overriding"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method overload with a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<Orm::WhereItem>")," as the first argument joins conditions using the ",(0,o.kt)("inlineCode",{parentName:"p"},"and")," operator by default:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where({\n                     {"first_name", "John"},\n                     {"votes", 50, ">"},\n                 }).get();\n')),(0,o.kt)("p",null,"Conditions operator can be overridden by the fourth argument in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::WhereItem")," structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where({\n                     {"first_name", "John"},\n                     {"votes", 50, ">", "or"},\n                 }).get();\n')),(0,o.kt)("p",null,"Or by the second ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," argument, in this case all conditions will be joined by this condition, but it is still possible to override them by the fourth argument in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::WhereItem")," structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where({\n                     {"first_name", "John"},\n                     {"last_name", "Smith"},\n                     {"votes", 50, ">", "and"},\n                 }, "or")\n                 .get();\n')),(0,o.kt)("p",null,"The example above will produce the following SQL:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'select * from users where (first_name = "John" or last_name = "Smith" and votes > 50)\n')),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Still, it is a better idea to use ",(0,o.kt)("a",{parentName:"p",href:"#logical-grouping"},"Logical Grouping")," described few lines below, which allows better control of the parentheses."))),(0,o.kt)("h3",{id:"additional-where-clauses"},"Additional Where Clauses"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"whereIn / whereNotIn / orWhereIn / orWhereNotIn")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereIn")," method verifies that a given column's value is contained within the given ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<QVariant>"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereIn("id", {1, 2, 3})\n                 .get();\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereNotIn")," method verifies that the given column's value is not contained in the given ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<QVariant>"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereNotIn("id", {1, 2, 3})\n                 .get();\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"whereNull / whereNotNull / orWhereNull / orWhereNotNull")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereNull")," method verifies that the value of the given column is ",(0,o.kt)("inlineCode",{parentName:"p"},"NULL"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereNull("updated_at")\n                 .get();\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereNotNull")," method verifies that the column's value is not ",(0,o.kt)("inlineCode",{parentName:"p"},"NULL"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereNotNull("updated_at")\n                 .get();\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"whereColumn / orWhereColumn")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"whereColumnEq")," method may be used to verify that two columns are equal:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereColumnEq("first_name", "last_name")\n                 .get();\n')),(0,o.kt)("p",null,"You may also pass a comparison operator to the ",(0,o.kt)("inlineCode",{parentName:"p"},"whereColumn")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereColumn("updated_at", ">", "created_at")\n                 .get();\n')),(0,o.kt)("p",null,"You may also pass a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<Orm::WhereColumnItem>")," of column comparisons to the ",(0,o.kt)("inlineCode",{parentName:"p"},"whereColumn")," method. These conditions will be joined using the ",(0,o.kt)("inlineCode",{parentName:"p"},"and")," operator:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereColumn({\n                     {"first_name", "last_name"},\n                     {"updated_at", "created_at", ">"},\n                 }).get();\n')),(0,o.kt)("p",null,"Conditions operator can also be overridden by the fourth argument in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Orm::WhereColumnItem")," structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereColumn({\n                     {"first_name", "last_name"},\n                     {"updated_at", "created_at", ">", "or"},\n                 }).get();\n')),(0,o.kt)("p",null,"Or by the second ",(0,o.kt)("inlineCode",{parentName:"p"},"whereColumn")," argument:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->whereColumn({\n                     {"first_name", "last_name"},\n                     {"updated_at", "created_at", ">"},\n                 }, "or")\n                 .get();\n')),(0,o.kt)("h3",{id:"logical-grouping"},"Logical Grouping"),(0,o.kt)("p",null,'Sometimes you may need to group several "where" clauses within parentheses in order to achieve your query\'s desired logical grouping. In fact, you should generally always group calls to the ',(0,o.kt)("inlineCode",{parentName:"p"},"orWhere")," method in parentheses in order to avoid unexpected query behavior. To accomplish this, you may pass a lambda expression to the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->where("name", "=", "John")\n                 .where([](auto &query)\n                 {\n                     query.where("votes", ">", 100)\n                          .orWhere("title", "=", "Admin");\n                 })\n                 .get();\n')),(0,o.kt)("p",null,"As you can see, passing a lambda expression into the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method instructs the query builder to begin a constraint group. The lambda expression will receive a query builder instance which you can use to set the constraints that should be contained within the parenthesis group. The example above will produce the following SQL:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'select * from users where name = "John" and (votes > 100 or title = "Admin")\n')),(0,o.kt)("h2",{id:"advanced-where-clauses"},"Advanced Where Clauses"),(0,o.kt)("h3",{id:"subquery-where-clauses"},"Subquery Where Clauses"),(0,o.kt)("p",null,'Sometimes you may need to construct a "where" clause that compares the results of a subquery to a given value. You may accomplish this by passing a lambda expression and a value to the ',(0,o.kt)("inlineCode",{parentName:"p"},"where"),' method. For example, the following query will retrieve all users who have a recent "membership" of a given type:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include "models/user.hpp"\n\nauto users = User::whereEq([](auto &query)\n{\n    query.select("type")\n         .from("membership")\n         .whereColumnEq("membership.user_id", "users.id")\n         .orderByDesc("membership.start_date")\n         .limit(1);\n}, "Pro")->get();\n')),(0,o.kt)("p",null,'Or, you may need to construct a "where" clause that compares a column to the results of a subquery. You may accomplish this by passing a column, operator, and lambda expression to the ',(0,o.kt)("inlineCode",{parentName:"p"},"where")," method. For example, the following query will retrieve all income records where the amount is less than average;"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'#include "models/income.hpp"\n\nauto incomes = Income::where("amount", "<", [](auto &query)\n{\n    query.selectRaw("avg(i.amount)").from("incomes as i");\n})->get();\n')),(0,o.kt)("h2",{id:"ordering-grouping-limit-and-offset"},"Ordering, Grouping, Limit & Offset"),(0,o.kt)("h3",{id:"ordering"},"Ordering"),(0,o.kt)("h4",{id:"the-orderby-method"},"The ",(0,o.kt)("inlineCode",{parentName:"h4"},"orderBy")," Method"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"orderBy")," method allows you to sort the results of the query by a given column. The first argument accepted by the ",(0,o.kt)("inlineCode",{parentName:"p"},"orderBy")," method should be the column you wish to sort by, while the second argument determines the direction of the sort and may be either ",(0,o.kt)("inlineCode",{parentName:"p"},"asc")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"desc"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->orderBy("name", "desc")\n                 .get();\n')),(0,o.kt)("p",null,"To sort by multiple columns, you may simply invoke ",(0,o.kt)("inlineCode",{parentName:"p"},"orderBy")," as many times as necessary:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->orderBy("name", "desc")\n                 .orderBy("email", "asc")\n                 .get();\n')),(0,o.kt)("h4",{id:"the-latest--oldest-methods"},"The ",(0,o.kt)("inlineCode",{parentName:"h4"},"latest")," & ",(0,o.kt)("inlineCode",{parentName:"h4"},"oldest")," Methods"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"latest")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"oldest")," methods allow you to easily order results by date. By default, the result will be ordered by the table's ",(0,o.kt)("inlineCode",{parentName:"p"},"created_at")," column. Or, you may pass the column name that you wish to sort by:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto user = DB::table("users")\n                ->latest()\n                .first();\n')),(0,o.kt)("h4",{id:"removing-existing-orderings"},"Removing Existing Orderings"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"reorder"),' method removes all of the "order by" clauses that have previously been applied to the query:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto &query = DB::table("users")->orderBy("name");\n\nauto unorderedUsers = query.reorder().get();\n')),(0,o.kt)("p",null,"You may pass a column and direction when calling the ",(0,o.kt)("inlineCode",{parentName:"p"},"reorder"),' method in order to remove all existing "order by" clauses and apply an entirely new order to the query:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto &query = DB::table("users")->orderBy("name");\n\nauto usersOrderedByEmail = query.reorder("email", "desc").get();\n')),(0,o.kt)("h3",{id:"grouping"},"Grouping"),(0,o.kt)("h4",{id:"the-groupby--having-methods"},"The ",(0,o.kt)("inlineCode",{parentName:"h4"},"groupBy")," & ",(0,o.kt)("inlineCode",{parentName:"h4"},"having")," Methods"),(0,o.kt)("p",null,"As you might expect, the ",(0,o.kt)("inlineCode",{parentName:"p"},"groupBy")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"having")," methods may be used to group the query results. The ",(0,o.kt)("inlineCode",{parentName:"p"},"having")," method's signature is similar to that of the ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->groupBy("account_id")\n                 .having("account_id", ">", 100)\n                 .get();\n')),(0,o.kt)("p",null,"You may pass multiple items to the ",(0,o.kt)("inlineCode",{parentName:"p"},"groupBy")," method to group by multiple columns:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->groupBy({"first_name", "status"})\n                 .having("account_id", ">", 100)\n                 .get();\n')),(0,o.kt)("h3",{id:"limit-and-offset"},"Limit & Offset"),(0,o.kt)("h4",{id:"the-skip--take-methods"},"The ",(0,o.kt)("inlineCode",{parentName:"h4"},"skip")," & ",(0,o.kt)("inlineCode",{parentName:"h4"},"take")," Methods"),(0,o.kt)("p",null,"You may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"skip")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"take")," methods to limit the number of results returned from the query or to skip a given number of results in the query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")->skip(10).take(5).get();\n')),(0,o.kt)("p",null,"Alternatively, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"limit")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"offset")," methods. These methods are functionally equivalent to the ",(0,o.kt)("inlineCode",{parentName:"p"},"take")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"skip")," methods, respectively:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto users = DB::table("users")\n                 ->offset(10)\n                 .limit(5)\n                 .get();\n')),(0,o.kt)("h2",{id:"insert-statements"},"Insert Statements"),(0,o.kt)("p",null,"The query builder also provides an ",(0,o.kt)("inlineCode",{parentName:"p"},"insert")," method that may be used to insert records into the database table. The ",(0,o.kt)("inlineCode",{parentName:"p"},"insert")," method accepts the ",(0,o.kt)("inlineCode",{parentName:"p"},"QVariantMap")," of column names and values:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->insert({\n    {"email", "kayla@example.com"},\n    {"votes", 0},\n});\n')),(0,o.kt)("p",null,"You may insert several records at once by passing a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<QVariantMap>"),". Each QVariantMap represents a record that should be inserted into the table:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->insert({\n    {{"email", "picard@example.com"}, {"votes", 0}},\n    {{"email", "janeway@example.com"}, {"votes", 0}},\n});\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"insertOrIgnore")," method will ignore duplicate record errors while inserting records into the database:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->insertOrIgnore({\n    {{"id", 1}, {"email", "sisko@example.com"}},\n    {{"id", 2}, {"email", "archer@example.com"}},\n});\n')),(0,o.kt)("h4",{id:"auto-incrementing-ids"},"Auto-Incrementing IDs"),(0,o.kt)("p",null,"If the table has an auto-incrementing id, use the ",(0,o.kt)("inlineCode",{parentName:"p"},"insertGetId")," method to insert a record and then retrieve the ID:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto id = DB::table("users")->insertGetId({\n    {"email", "john@example.com"},\n    {"votes", 0},\n});\n')),(0,o.kt)("h2",{id:"update-statements"},"Update Statements"),(0,o.kt)("p",null,"In addition to inserting records into the database, the query builder can also update existing records using the ",(0,o.kt)("inlineCode",{parentName:"p"},"update")," method. The ",(0,o.kt)("inlineCode",{parentName:"p"},"update")," method, accepts a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<Orm::UpdateItem>")," of column and value pairs, indicating the columns to be updated and returns a ",(0,o.kt)("inlineCode",{parentName:"p"},"std::tuple<int, QSqlQuery>")," . You may constrain the ",(0,o.kt)("inlineCode",{parentName:"p"},"update")," query using ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," clauses:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'auto [affected, query] = DB::table("users")\n                             ->whereEq("id", 1)\n                             .update({{"votes", 1}});\n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"An ",(0,o.kt)("inlineCode",{parentName:"p"},"update")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"delete")," are affecting statements, so they return ",(0,o.kt)("inlineCode",{parentName:"p"},"std::tuple<int, QSqlQuery>"),"."))),(0,o.kt)("h3",{id:"increment-and-decrement"},"Increment & Decrement"),(0,o.kt)("p",null,"The query builder also provides convenient methods for incrementing or decrementing the value of a given column. Both of these methods accept at least one argument: the column to modify. A second argument may be provided to specify the amount by which the column should be incremented or decremented:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->increment<int>("votes");\n\nDB::table("users")->increment("votes", 5);\n\nDB::table("users")->decrement<int>("votes");\n\nDB::table("users")->decrement("votes", 5.2); // float or double type\n')),(0,o.kt)("p",null,"You may also specify additional columns to update during the operation as a ",(0,o.kt)("inlineCode",{parentName:"p"},"QVector<Orm::UpdateItem>"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->increment("votes", 1, {{"name", "John"}});\n')),(0,o.kt)("p",null,"You should constrain ",(0,o.kt)("inlineCode",{parentName:"p"},"increment"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"decrement")," by ",(0,o.kt)("inlineCode",{parentName:"p"},"where")," to update only specific record in the database, otherwise a column in all records will be modified."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->whereEq("id", 1).increment("votes", 5);\n')),(0,o.kt)("h2",{id:"delete-statements"},"Delete Statements"),(0,o.kt)("p",null,"The query builder's ",(0,o.kt)("inlineCode",{parentName:"p"},"remove"),", or an alias ",(0,o.kt)("inlineCode",{parentName:"p"},"deleteRow")," method may be used to delete records from the table. You may constrain ",(0,o.kt)("inlineCode",{parentName:"p"},"delete"),' statements by adding "where" clauses before calling the ',(0,o.kt)("inlineCode",{parentName:"p"},"delete")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->remove();\n\nDB::table("users")->where("votes", ">", 100).remove();\n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},(0,o.kt)("inlineCode",{parentName:"p"},"delete")," can not be used as the method name because it is the reserved word."))),(0,o.kt)("p",null,"You may also pass record ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"remove")," method as the first argument, it is the shortcut method, which internally calls ",(0,o.kt)("inlineCode",{parentName:"p"},"where"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->remove(2);\n')),(0,o.kt)("h3",{id:"truncate-statement"},"Truncate Statement"),(0,o.kt)("p",null,"If you wish to truncate an entire table, which will remove all records from the table and reset the auto-incrementing ID to zero, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"truncate")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")->truncate();\n')),(0,o.kt)("h4",{id:"table-truncation--postgresql"},"Table Truncation & PostgreSQL"),(0,o.kt)("p",null,"When truncating a PostgreSQL database, the ",(0,o.kt)("inlineCode",{parentName:"p"},"CASCADE")," behavior will be applied. This means that all foreign key related records in other tables will be deleted as well."),(0,o.kt)("h2",{id:"pessimistic-locking"},"Pessimistic Locking"),(0,o.kt)("p",null,'The query builder also includes a few functions to help you achieve "pessimistic locking" when executing your ',(0,o.kt)("inlineCode",{parentName:"p"},"select"),' statements. To execute a statement with a "shared lock", you may call the ',(0,o.kt)("inlineCode",{parentName:"p"},"sharedLock")," method. A shared lock prevents the selected rows from being modified until your transaction is committed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")\n        ->where("votes", ">", 100)\n        .sharedLock()\n        .get();\n')),(0,o.kt)("p",null,"Alternatively, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"lockForUpdate"),' method. A "for update" lock prevents the selected records from being modified or from being selected with another shared lock:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'DB::table("users")\n        ->where("votes", ">", 100)\n        .lockForUpdate()\n        .get();\n')))}h.isMDXComponent=!0}}]);